{
	"name": "QRY03_MA1",
	"properties": {
		"description": "Query Provisão de Guias.\nEtapa Movimento Acerto 1 (MA1)",
		"folder": {
			"name": "FATOS/MENSAIS/PROVISAO"
		},
		"content": {
			"query": "SELECT DISTINCT \n\n   'MA1' AS CTL_ORIGEM_DADOS,\n   SYSDATETIME() AS DT_CARGA,\n   --TO_DATE('#par_DATA_REF#','YYYY-MM-DD') AS DT_REF_CARGA,\n   CAST('2022-07-22' AS DATE) AS DT_REF_CARGA,\n   PEG.HANDLE AS HD_PEG,\n   G.HANDLE AS HD_GUIA,\n   ACE.HANDLE AS HD_GUIA_EVENTOS,\n   FAT.HANDLE AS HD_FATURA,\n   BEN.HANDLE AS HD_BENEF_EVENTO,\n   B1.HANDLE AS HD_BENEF_TITULAR,\n   CON.HANDLE AS HD_CONTRATO,\n   TGE.HANDLE AS HD_TGE,\n   PRE.PRESTADOR AS CO_PRESTADOR,\n   PEG.TABREGIMEPGTO AS CO_REGIME_PAGAMENTO, \n   PEG.PEG AS NU_PEG,\n   G.GUIA AS NU_GUIA,\n   FAT.NUMERO AS NU_FATURA,\n   RP.NUMEROPROTOCOLO AS NU_PROTOCOLO,\n   RP.SITUACAO AS ST_PROTOCOLO,\n   RG.SITUACAO AS ST_GUIA_REV_PAGTO,\n   \n   GE.DATAATENDIMENTO AS DATAATENDIMENTO,\n   RP.DATAAVISO AS DATAAVISO,\n   RP.DATAPEDIDO AS DATA_RECEB_CEPAG_PEDIDO,\n   FAT.DATACONTABIL AS DATACONTABIL,\n   RP.DATAPAGAMENTOACERTO AS DATA_PREVISTA_PAGTO_ACERTO,\n\n   ACE.VALORPGTOACERTO AS VALOR_APRESENTADO,\n   RE.VALORCALCULADO AS VALOR_CALC_PAGTO,\n   --NVL(ACE.VALORPGTOACERTO - ACE.VALORPGTOORIGINAL, FAT.VALOR) AS VALOR_A_PAGAR,\n   ISNULL(ACE.VALORPGTOACERTO - ACE.VALORPGTOORIGINAL, FAT.VALOR) AS VALOR_A_PAGAR,\n   ACE.VALORAPRESENTADOACERTO - ACE.VALORPGTOACERTO AS VALOR_GLOSADO,\n   ACE.VALORAUXILIOBENEFICIARIOACERTO - ACE.VALORAUXILIOBENEFORIGINAL AS VALOR_PAS\n\nFROM PROSTG.SFN_FATURA FAT\n     LEFT JOIN PROSTG.SIS_TIPOFATURAMENTO TPF ON TPF.HANDLE = FAT.TIPOFATURAMENTO\n     JOIN PROSTG.SFN_TIPOFATURA TF ON TF.HANDLE = FAT.TIPOFATURA AND TF.CODIGO IN (410, 411)\n     JOIN PROSTG.SAM_ACERTO_FATURA ACF ON FAT.HANDLE = ACF.FATURAACERTO\n     JOIN PROSTG.SAM_GUIA_EVENTOS_ACERTO ACE ON ACE.HANDLE = ACF.GUIAEVENTOACERTO\n     JOIN PROSTG.SAM_ACERTOLOTE ACL ON ACL.HANDLE = ACE.ACERTOLOTE\n     LEFT JOIN PROSTG.SAM_REVISAOPAGTO RP ON RP.HANDLE = ACL.REVISAOPAGTO\n     LEFT JOIN PROSTG.SAM_TGE TGE ON TGE.HANDLE = ACE.EVENTOACERTO\n     LEFT JOIN PROSTG.SAM_CLASSEEVENTO CL ON CL.HANDLE = TGE.CLASSEEVENTO\n     LEFT JOIN PROSTG.SAM_GUIA_EVENTOS GE ON GE.HANDLE = ACE.GUIAEVENTO\n     LEFT JOIN PROSTG.SAM_GUIA G  ON G.HANDLE = GE.GUIA\n     LEFT JOIN PROSTG.SAM_REVISAOPAGTO_GUIA RG ON RP.HANDLE = RG.REVISAOPAGTO\n     JOIN PROSTG.SAM_REVISAOPAGTO_EVENTO RE ON RG.HANDLE = RE.REVISAOPAGTOGUIA AND RE.GUIAEVENTO = GE.HANDLE\n     LEFT JOIN PROSTG.SAM_PEG PEG  ON PEG.HANDLE = G.PEG\n     LEFT JOIN PROSTG.SAM_PRESTADOR PRE ON PRE.HANDLE = PEG.RECEBEDOR\n     LEFT JOIN PROSTG.SAM_BENEFICIARIO BEN  ON BEN.HANDLE = ISNULL(ACE.BENEFICIARIOACERTO, PEG.BENEFICIARIO)\n     LEFT JOIN PROSTG.SAM_FAMILIA FAM ON FAM.HANDLE = BEN.FAMILIA\n     LEFT JOIN PROSTG.SAM_BENEFICIARIO B1 ON B1.HANDLE = FAM.TITULARRESPONSAVEL\n     LEFT JOIN PROSTG.SAM_CONTRATO CON ON CON.HANDLE = BEN.CONTRATO\n     LEFT JOIN PROSTG.SAM_GRUPOCONTRATO GPL ON CON.GRUPOCONTRATO = GPL.HANDLE\n\n--WHERE FAT.DATACONTABIL BETWEEN ADD_MONTHS(TO_DATE(TO_CHAR(TO_DATE('#par_DATA_REF#','YYYY-MM-DD'), 'YYYY-MM')||'-01','YYYY-MM-DD'), 1) AND ADD_MONTHS(LAST_DAY(TO_DATE('#par_DATA_REF#','YYYY-MM-DD')), 1)\nWHERE FAT.DATACONTABIL BETWEEN FORMAT(DATEADD(MONTH, 1, CONCAT(FORMAT(CAST('2022-07-22' AS DATE),'yyyy-MM'),'-01')),'yyyy-MM-dd') AND FORMAT(EOMONTH(DATEADD(MONTH, 1, CAST('2022-07-22' AS DATE))),'yyyy-MM-dd')\n\n   AND RP.DATAPEDIDO IS NOT NULL\n   --AND RP.DATAPEDIDO <= LAST_DAY(TO_DATE('#par_DATA_REF#','YYYY-MM-DD'))\n   AND RP.DATAPEDIDO <= EOMONTH(CAST('2022-07-22' AS DATE))\n   AND CON.HANDLE IS NOT NULL --Plano/Contrato não nulo\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "synsqlprod",
				"poolName": "synsqlprod"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}